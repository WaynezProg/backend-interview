#!/bin/bash

# ============================================================================
# âš ï¸  æ³¨æ„ï¼šæ­¤è…³æœ¬ç‚ºæ­·å²ä¿®å¾©è…³æœ¬ï¼Œç¾å·²ä¸éœ€è¦ä½¿ç”¨
# ============================================================================
# 
# æ­¤è…³æœ¬ç”¨æ–¼ä¿®å¾© bcrypt å¯†ç¢¼åŠ å¯†å…¼å®¹æ€§å•é¡Œï¼ˆ2024å¹´10æœˆï¼‰ã€‚
# 
# ã€ç¾ç‹€èªªæ˜ã€‘
# - âœ… å•é¡Œå·²åœ¨ç¨‹å¼ç¢¼ä¸­ä¿®å¾©ï¼ˆbackend/auth.py å·²åŠ å…¥å¯†ç¢¼é•·åº¦æˆªæ–·é‚è¼¯ï¼‰
# - âœ… ä¾è³´ç‰ˆæœ¬å·²åœ¨ requirements.txt ä¸­é–å®šï¼ˆbcrypt==4.0.1ï¼‰
# - âœ… æ–°ç’°å¢ƒå¯ç›´æ¥ä½¿ç”¨ `pip install -r requirements.txt` å®‰è£
# 
# ã€ä½•æ™‚éœ€è¦æ­¤è…³æœ¬ã€‘
# åƒ…åœ¨ä»¥ä¸‹æƒ…æ³éœ€è¦åŸ·è¡Œæ­¤è…³æœ¬ï¼š
# 1. ç¾æœ‰ç’°å¢ƒä¸­ bcrypt ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œå‡ºç¾å¯†ç¢¼åŠ å¯†éŒ¯èª¤
# 2. éœ€è¦å¿«é€Ÿä¿®å¾©èˆŠç’°å¢ƒçš„ä¾è³´å•é¡Œ
# 
# ã€æ–°ç’°å¢ƒè¨­ç½®ã€‘
# å°æ–¼æ–°ç’°å¢ƒï¼Œå»ºè­°ç›´æ¥ä½¿ç”¨ï¼š
# ```bash
# cd backend
# python3 -m venv venv
# source venv/bin/activate
# pip install -r requirements.txt
# ```
# 
# ============================================================================

echo "ğŸ”§ ä¿®å¾© bcrypt å¯†ç¢¼åŠ å¯†å•é¡Œ"
echo "================================"
echo "âš ï¸  æ³¨æ„ï¼šæ­¤è…³æœ¬ç‚ºæ­·å²ä¿®å¾©è…³æœ¬"
echo "   æ–°ç’°å¢ƒå»ºè­°ç›´æ¥ä½¿ç”¨: pip install -r requirements.txt"
echo "================================"

cd backend

# æ¿€æ´»è™›æ“¬ç’°å¢ƒ
if [ -d "venv" ]; then
    echo "ğŸ”§ æ¿€æ´»è™›æ“¬ç’°å¢ƒ..."
    source venv/bin/activate
else
    echo "ğŸ“¦ å‰µå»ºè™›æ“¬ç’°å¢ƒ..."
    python3 -m venv venv
    source venv/bin/activate
fi

# å‡ç´š pip
echo "ğŸ“¦ å‡ç´š pip..."
pip install --upgrade pip

# å¸è¼‰æœ‰å•é¡Œçš„ bcrypt ç‰ˆæœ¬
echo "ğŸ—‘ï¸  å¸è¼‰èˆŠç‰ˆ bcrypt..."
pip uninstall -y bcrypt

# å®‰è£å…¼å®¹çš„ bcrypt ç‰ˆæœ¬
echo "ğŸ“¦ å®‰è£å…¼å®¹çš„ bcrypt ç‰ˆæœ¬..."
pip install bcrypt==4.0.1

# é‡æ–°å®‰è£ passlib
echo "ğŸ“¦ é‡æ–°å®‰è£ passlib..."
pip install --force-reinstall passlib[bcrypt]==1.7.4

# å®‰è£å…¶ä»–ä¾è³´
echo "ğŸ“¦ å®‰è£å…¶ä»–ä¾è³´..."
pip install -r requirements.txt

echo ""
echo "âœ… bcrypt ä¿®å¾©å®Œæˆï¼"
echo "ç¾åœ¨å¯ä»¥é‡æ–°å•Ÿå‹•æœå‹™ï¼š"
echo "  python run.py"
echo "================================"
